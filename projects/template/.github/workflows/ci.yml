name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DEVOPS_REPO_URL: "https://github.com/kibshh/Devops-Embedded-C-Station.git"
  DOCKER_IMAGE: "embedded-c-devops:latest"

jobs:
  build-native:
    name: Build (Native)
    runs-on: ubuntu-latest
    
    steps:
    - name: Extract DevOps repo owner/repo
      id: devops-repo
      run: |
        REPO_URL="${{ env.DEVOPS_REPO_URL }}"
        # Remove https://github.com/ prefix and .git suffix
        REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
        echo "repository=$REPO_PATH" >> $GITHUB_OUTPUT
    
    - name: Checkout project
      uses: actions/checkout@v4
    
    - name: Checkout DevOps repo (for Dockerfile)
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.devops-repo.outputs.repository }}
        path: devops-infra
        # If private repo, add: token: ${{ secrets.DEVOPS_REPO_TOKEN }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: devops-infra/
        file: devops-infra/docker/Dockerfile
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true
    
    - name: Build project (native)
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.DOCKER_IMAGE }} \
          make clean && make
    
    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.DOCKER_IMAGE }} \
          bash -c "if make -n test >/dev/null 2>&1; then make test; else echo 'No test target found in Makefile. Skipping tests.'; fi"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: native-build
        path: |
          build/*
          !build/*.o

  build-arm:
    name: Build (ARM)
    runs-on: ubuntu-latest
    
    steps:
    - name: Extract DevOps repo owner/repo
      id: devops-repo
      run: |
        REPO_URL="${{ env.DEVOPS_REPO_URL }}"
        # Remove https://github.com/ prefix and .git suffix
        REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
        echo "repository=$REPO_PATH" >> $GITHUB_OUTPUT
    
    - name: Checkout project
      uses: actions/checkout@v4
    
    - name: Checkout DevOps repo (for Dockerfile)
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.devops-repo.outputs.repository }}
        path: devops-infra
        # If private repo, add: token: ${{ secrets.DEVOPS_REPO_TOKEN }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: devops-infra/
        file: devops-infra/docker/Dockerfile
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true
    
    - name: Build project (ARM)
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.DOCKER_IMAGE }} \
          make clean && make TARGET=arm
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: arm-build
        path: |
          build/*.elf
          build/*.hex
          build/*.bin

